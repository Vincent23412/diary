<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Event Loop2</title>
  <link rel="stylesheet" href="/notes/style.css" />
</head>
<body>
  <header class="container py-24">
    <h1 class="title">Event Loop2</h1>
    <nav class="nav">
      <a href="/notes/nodejs/index.html" class="nav-link">â† å›åˆ†é¡</a>
      <a href="/notes/index.html" class="nav-link">å›ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container card">
    <article class="post-content">
      <h1 id="nodejs">ğŸ§  Node.js äº‹ä»¶è¿´åœˆç­†è¨˜ç¸½æ•´ç†</h1>
<h2 id="_1">ğŸ“ åŸºæœ¬æ¦‚å¿µ</h2>
<p>Node.js çš„äº‹ä»¶è¿´åœˆï¼ˆEvent Loopï¼‰æ˜¯éåŒæ­¥æ¶æ§‹çš„æ ¸å¿ƒï¼Œè² è²¬å”èª¿å„ç¨®éåŒæ­¥ä»»å‹™çš„åŸ·è¡Œé †åºã€‚æ¯ä¸€è¼ªäº‹ä»¶è¿´åœˆç¨±ç‚ºä¸€å€‹ <strong>tick</strong>ï¼Œæ¯å€‹ tick åŒ…å«å¤šå€‹éšæ®µï¼ˆphasesï¼‰ã€‚</p>
<hr />
<h2 id="_2">ğŸ“Š äº‹ä»¶è¿´åœˆéšæ®µï¼ˆç°¡åŒ–ç‰ˆï¼‰</h2>
<table>
<thead>
<tr>
<th>éšæ®µåç¨±</th>
<th>èªªæ˜èˆ‡ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>timers</strong></td>
<td>åŸ·è¡Œåˆ°æœŸçš„ <code>setTimeout()</code> å’Œ <code>setInterval()</code> å›å‘¼</td>
</tr>
<tr>
<td><strong>pending</strong></td>
<td>æŸäº›éŒ¯èª¤å»¶é²å›å‘¼ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td><strong>idle/prepare</strong></td>
<td>Node.js å…§éƒ¨ç”¨</td>
</tr>
<tr>
<td><strong>poll</strong></td>
<td>ç­‰å¾… I/O äº‹ä»¶ã€åŸ·è¡Œ I/O å›å‘¼ï¼ˆå¦‚ <code>fs.readFile</code>ï¼‰</td>
</tr>
<tr>
<td><strong>check</strong></td>
<td>åŸ·è¡Œ <code>setImmediate()</code></td>
</tr>
<tr>
<td><strong>close</strong></td>
<td>åŸ·è¡Œ <code>close</code> äº‹ä»¶å›å‘¼ï¼ˆå¦‚ socket è¢«éŠ·æ¯€ï¼‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_3">ğŸ§µ ç‰¹æ®Šæ©Ÿåˆ¶ï¼ˆéå±¬æ–¼äº‹ä»¶è¿´åœˆéšæ®µï¼‰</h2>
<table>
<thead>
<tr>
<th>é¡å‹</th>
<th>åŸ·è¡Œæ™‚æ©Ÿèªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process.nextTick()</code></td>
<td>åœ¨ <strong>ç•¶å‰äº‹ä»¶å¾ªç’°éšæ®µå®Œæˆå‰</strong> åŸ·è¡Œï¼ˆå„ªå…ˆï¼‰</td>
</tr>
<tr>
<td><strong>Microtasks</strong>ï¼ˆå¦‚ <code>Promise.then()</code>ã€<code>queueMicrotask()</code>ï¼‰</td>
<td>åœ¨äº‹ä»¶å¾ªç’°éšæ®µçµæŸå¾ŒåŸ·è¡Œï¼Œä½†æ¯” macrotask æ›´æ—©</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_4">ğŸ”¼ ä»»å‹™å„ªå…ˆé †åºï¼ˆå¾å¿«åˆ°æ…¢ï¼‰</h2>
<ol>
<li><code>process.nextTick()</code> âœ…ï¼ˆæœ€é«˜å„ªå…ˆï¼‰</li>
<li><code>Promise.then()</code> / <code>queueMicrotask()</code>ï¼ˆmicrotask queueï¼‰</li>
<li><code>setTimeout(fn, 0)</code>ï¼ˆä¸‹ä¸€è¼ª timers éšæ®µï¼‰</li>
<li><code>setImmediate()</code>ï¼ˆä¸‹ä¸€è¼ª check éšæ®µï¼‰</li>
</ol>
<hr />
<h2 id="_5">ğŸ”§ æ¯”è¼ƒç¸½è¡¨</h2>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>process.nextTick()</code></th>
<th><code>Promise.then()</code></th>
<th><code>setTimeout()</code></th>
<th><code>setImmediate()</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>æ˜¯å¦ microtask</td>
<td>âŒï¼ˆç‰¹æ®Š queueï¼‰</td>
<td>âœ… microtask</td>
<td>âŒ macrotask</td>
<td>âŒ macrotask</td>
</tr>
<tr>
<td>åŸ·è¡Œæ™‚æ©Ÿ</td>
<td>ç•¶å‰ call stack æ¸…ç©ºå¾Œ</td>
<td>microtask éšŠåˆ—</td>
<td>ä¸‹ä¸€è¼ªäº‹ä»¶å¾ªç’°çš„ timers éšæ®µ</td>
<td>ä¸‹ä¸€è¼ªäº‹ä»¶å¾ªç’°çš„ check éšæ®µ</td>
</tr>
<tr>
<td>ç©©å®šæ€§</td>
<td>æœƒé€ æˆ starvationï¼Œè«‹å°å¿ƒä½¿ç”¨</td>
<td>ç©©å®š</td>
<td>å®¹æ˜“å»¶é²</td>
<td>âœ… I/O å¾Œæ¨è–¦ä½¿ç”¨</td>
</tr>
<tr>
<td>é©ç”¨å ´æ™¯</td>
<td>éŒ¯èª¤å›å‚³ã€ä¿è­‰ callback éåŒæ­¥</td>
<td>éåŒæ­¥æµç¨‹æ§åˆ¶</td>
<td>ä¸€èˆ¬å»¶é²</td>
<td>I/O å›å‘¼å¾Œçš„å¾ŒçºŒé‚è¼¯</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_6">ğŸ§ª ä¾‹å­è§£æ</h2>
<h3 id="1-nexttick-setimmediate">1ï¸âƒ£ <code>nextTick</code> èˆ‡ <code>setImmediate</code> æ¯”è¼ƒï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;nextTick&quot;</span><span class="p">));</span>
<span class="nx">setImmediate</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;setImmediate&quot;</span><span class="p">));</span>
</code></pre></div>

<p>â¡ï¸ è¼¸å‡ºé †åºï¼š</p>
<div class="codehilite"><pre><span></span><code>nextTick
setImmediate
</code></pre></div>

<hr />
<h3 id="2">2ï¸âƒ£ å»ºæ§‹å‡½æ•¸ä¸­è§¸ç™¼äº‹ä»¶ï¼ˆè¦å»¶é²åŸ·è¡Œï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">MyEmitter</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>
<span class="w">    </span><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>â¡ï¸ ç¢ºä¿ä½¿ç”¨è€… <code>.on('ready')</code> æœ‰æ™‚é–“è¨»å†Š</p>
<hr />
<h3 id="3-io-setimmediate">3ï¸âƒ£ I/O ä¸­ä½¿ç”¨ <code>setImmediate</code></h3>
<div class="codehilite"><pre><span></span><code><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setImmediate</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;immediate&quot;</span><span class="p">));</span><span class="w">  </span><span class="c1">// âœ… ç©©å®š</span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span><span class="w">   </span><span class="c1">// âŒ æ™‚æ©Ÿå¯èƒ½å»¶é²</span>
<span class="p">});</span>
</code></pre></div>

<p>â¡ï¸ <code>setImmediate</code> æ¯” <code>setTimeout(..., 0)</code> æ›´ç©©å®šåœ°åœ¨ I/O å¾ŒåŸ·è¡Œ</p>
<hr />
<h2 id="starvation">âš ï¸ æ½›åœ¨å•é¡Œï¼šStarvationï¼ˆé£¢é¤“ï¼‰</h2>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="nx">loop</span><span class="p">);</span><span class="w">  </span><span class="c1">// âŒ ç„¡é™å¡åœ¨ nextTick queueï¼Œå…¶ä»–ä»»å‹™ç„¡æ³•åŸ·è¡Œ</span>
<span class="p">}</span>
<span class="nx">loop</span><span class="p">();</span>
</code></pre></div>

<p>â¡ï¸ æ°¸é ç„¡æ³•é€²å…¥ä¸‹ä¸€éšæ®µ â†’ âŒ I/O ç„¡æ³•è§¸ç™¼ï¼Œæ•ˆèƒ½è¢«é–æ­»</p>
<hr />
<h2 id="_7">âœ… æœ€ä½³å¯¦å‹™ç¸½çµ</h2>
<table>
<thead>
<tr>
<th>ä½ è¦åšä»€éº¼ï¼Ÿ</th>
<th>ä½¿ç”¨å“ªå€‹ï¼Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¢ºä¿ callback éåŒæ­¥ã€å›å‚³éŒ¯èª¤å‰çµ¦ä½¿ç”¨è€…æ©Ÿæœƒè™•ç†</td>
<td><code>process.nextTick()</code></td>
</tr>
<tr>
<td>åœ¨ async æµç¨‹ä¸­æ’ microtask</td>
<td><code>Promise.then()</code> / <code>await</code></td>
</tr>
<tr>
<td>è™•ç† I/O å®Œå¾Œçš„ä»»å‹™</td>
<td><code>setImmediate()</code></td>
</tr>
<tr>
<td>åšå®šæ™‚æ’ç¨‹</td>
<td><code>setTimeout()</code> æˆ– <code>setInterval()</code></td>
</tr>
</tbody>
</table>
<hr />
    </article>
    <p class="post-meta">
      åŸæ–‡ï¼š
      <a href="https://github.com/Vincent23412/diary/blob/main/content/nodejs/event_loop2.md" target="_blank">GitHub</a> Â·
      <a href="https://raw.githubusercontent.com/Vincent23412/diary/main/content/nodejs/event_loop2.md" target="_blank">raw</a>
    </p>
  </main>

  <footer class="container py-24">
    <small>æœ€å¾Œæ›´æ–°ï¼š2025-11-22</small>
  </footer>
</body>
</html>

<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Best Practice In Program</title>
  <link rel="stylesheet" href="/notes/style.css" />
</head>
<body>
  <header class="container py-24">
    <h1 class="title">Best Practice In Program</h1>
    <nav class="nav">
      <a href="/notes/nodejs/index.html" class="nav-link">â† å›åˆ†é¡</a>
      <a href="/notes/index.html" class="nav-link">å›ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container card">
    <article class="post-content">
      <p>ä»¥ä¸‹æ˜¯å®Œæ•´æ•´ç†çš„ Express ç”Ÿç”¢ç’°å¢ƒæœ€ä½³å¯¦è¸ç­†è¨˜ï¼ŒåŒ…å« Gzip å£“ç¸®ã€åŒæ­¥éåŒæ­¥ä½¿ç”¨ã€æ—¥èªŒè¨˜éŒ„ã€ä¾‹å¤–è™•ç†ï¼Œæ­é…ä½ å‰›å‰›å•çš„ req.locals è£œå……èªªæ˜ï¼š</p>
<hr />
<h1 id="nodejs-express">Node.js Express ç”Ÿç”¢ç’°å¢ƒæœ€ä½³å¯¦è¸æ•´ç†</h1>
<h2 id="1-gzip">1ï¸âƒ£ Gzip å£“ç¸®ï¼šæ¸›å°‘æµé‡ã€æå‡é€Ÿåº¦</h2>
<h3 id="_1">âœ… æ¦‚å¿µ</h3>
<ul>
<li>Gzip å£“ç¸®å¯é¡¯è‘—æ¸›å°‘å›æ‡‰é«”ç©ï¼Œæå‡ Web å’Œ API éŸ¿æ‡‰é€Ÿåº¦ã€‚</li>
</ul>
<h3 id="express">âœ… Express å¯¦ä½œ</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;compression&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">compression</span><span class="p">());</span>
</code></pre></div>

<h3 id="_2">âœ… ç”Ÿç”¢ç’°å¢ƒæ¨è–¦åšæ³•</h3>
<ul>
<li>é«˜æµé‡ç¶²ç«™å»ºè­°äº¤çµ¦ Nginx è™•ç† Gzipï¼š</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">gzip</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="k">gzip_types</span><span class="w"> </span><span class="s">text/plain</span><span class="w"> </span><span class="s">application/json</span><span class="w"> </span><span class="s">text/css</span><span class="w"> </span><span class="s">application/javascript</span><span class="p">;</span>
</code></pre></div>

<hr />
<h2 id="2">2ï¸âƒ£ é¿å…åŒæ­¥å‡½æ•¸ï¼šä¿æŒéåŒæ­¥ã€é¿å…å µå¡</h2>
<h3 id="_3">âœ… æ ¸å¿ƒæ¦‚å¿µ</h3>
<ul>
<li>åŒæ­¥å‡½æ•¸ï¼ˆä¾‹å¦‚ <code>fs.readFileSync()</code>ï¼‰æœƒé˜»å¡æ•´å€‹äº‹ä»¶è¿´åœˆï¼Œå½±éŸ¿æ•ˆèƒ½ã€‚</li>
<li>åœ¨ <strong>éåŒæ­¥ç‚ºä¸»çš„ Node.js</strong> ç’°å¢ƒï¼Œæ‡‰è©²ç›¡å¯èƒ½é¿å…åŒæ­¥æ“ä½œã€‚</li>
</ul>
<h3 id="_4">âœ… é–‹ç™¼æª¢æŸ¥æ–¹æ³•</h3>
<div class="codehilite"><pre><span></span><code>node<span class="w"> </span>--trace-sync-io<span class="w"> </span>app.js
</code></pre></div>

<ul>
<li>ä½¿ç”¨è©²æŒ‡ä»¤å¯è¿½è¹¤åŒæ­¥ API ä½¿ç”¨ä½ç½®ã€‚</li>
</ul>
<h3 id="_5">âœ… æ­£ç¢ºåšæ³•</h3>
<ul>
<li><strong>åªåœ¨å•Ÿå‹•æ™‚ç”¨åŒæ­¥ API</strong>ï¼ˆä¾‹å¦‚è®€å–è¨­å®šæª”ï¼‰ã€‚</li>
<li><strong>éåŒæ­¥ç‚ºä¸»</strong>ï¼š</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs/promises&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./test.txt&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="3-log-log">3ï¸âƒ£ æ­£ç¢ºæ—¥èªŒè¨˜éŒ„ï¼šå€åˆ†é™¤éŒ¯ log èˆ‡æ´»å‹• log</h2>
<h3 id="_6">âœ… å¸¸è¦‹å•é¡Œ</h3>
<ul>
<li><code>console.log()</code>ã€<code>console.error()</code> æ˜¯åŒæ­¥çš„ï¼Œä¸å»ºè­°ç”¨æ–¼é«˜ä½µç™¼ç”Ÿç”¢ç’°å¢ƒã€‚</li>
</ul>
<h3 id="_7">âœ… æ¨è–¦æ–¹æ¡ˆ</h3>
<table>
<thead>
<tr>
<th>ç”¨é€”</th>
<th>å·¥å…·</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>é™¤éŒ¯</td>
<td><code>debug</code></td>
<td>é–‹ç™¼ç”¨é™¤éŒ¯ logï¼Œä¸å½±éŸ¿æ­£å¼ç’°å¢ƒ</td>
</tr>
<tr>
<td>æ´»å‹•æ—¥èªŒ</td>
<td><code>pino</code></td>
<td>é«˜æ•ˆèƒ½éåŒæ­¥ logï¼Œæ”¯æ´ log ç­‰ç´šã€JSON è¼¸å‡º</td>
</tr>
</tbody>
</table>
<h3 id="debug">âœ… Debug ä½¿ç”¨æ–¹å¼</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;app:api&#39;</span><span class="p">);</span>
<span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;API called&#39;</span><span class="p">);</span>
</code></pre></div>

<p>åŸ·è¡Œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nv">$env</span>:DEBUG<span class="o">=</span><span class="s2">&quot;app:*&quot;</span><span class="p">;</span><span class="w"> </span>node<span class="w"> </span>app.js<span class="w"> </span><span class="c1"># Windows PowerShell</span>
</code></pre></div>

<h3 id="pino">âœ… Pino ä½¿ç”¨æ–¹å¼</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">pino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pino&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pino</span><span class="p">();</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;server started&#39;</span><span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="4">4ï¸âƒ£ æ­£ç¢ºä¾‹å¤–è™•ç†ï¼šé˜²æ­¢ç¨‹å¼å´©æ½°</h2>
<h3 id="_8">âœ… æ ¸å¿ƒè§€å¿µ</h3>
<ul>
<li>Node.js ä¸è™•ç†ä¾‹å¤–æ™‚ï¼Œæ‡‰ç”¨æœƒå´©æ½°ï¼Œ<strong>æ­£ç¢ºæ•æ‰ä¾‹å¤–æ˜¯ç©©å®šæ€§é—œéµ</strong>ã€‚</li>
</ul>
<h3 id="_9">âœ… åŒæ­¥éŒ¯èª¤è™•ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/search&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setImmediate</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Invalid JSON&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="asyncawait">âœ… éåŒæ­¥éŒ¯èª¤è™•ç† (async/await)</h3>
<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">userData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<p>å…¨å±€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<hr />
<h2 id="5-reqlocals-middleware">5ï¸âƒ£ req.locals å¯¦æˆ°ç”¨æ³•ï¼šè·¨ middleware å‚³éè³‡æ–™</h2>
<h3 id="_10">âœ… èªªæ˜</h3>
<ul>
<li>Express é è¨­æœ‰ <code>res.locals</code>ï¼Œä½† <code>req.locals</code> æ˜¯é–‹ç™¼è€…è‡ªå®šç¾©çš„å±¬æ€§ï¼Œç”¨ä¾†åœ¨å¤šå€‹ middleware å‚³éè³‡æ–™ï¼ˆä¾‹å¦‚ user è³‡è¨Šï¼‰ã€‚</li>
</ul>
<h3 id="_11">âœ… ç¯„ä¾‹</h3>
<div class="codehilite"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">req</span><span class="p">.</span><span class="nx">locals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<hr />
<h2 id="_12">ğŸ ç¸½çµ</h2>
<table>
<thead>
<tr>
<th>é …ç›®</th>
<th>æ ¸å¿ƒé‡é»</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gzip å£“ç¸®</td>
<td>Express å°å°ˆæ¡ˆç”¨ <code>compression()</code>ï¼Œå¤§å°ˆæ¡ˆå»ºè­°ç”¨ Nginx</td>
</tr>
<tr>
<td>é¿å…åŒæ­¥</td>
<td>ç”Ÿç”¢ç’°å¢ƒæ‡‰ç›¡å¯èƒ½å…¨éåŒæ­¥ï¼›ç”¨ <code>--trace-sync-io</code> æŸ¥æ¼</td>
</tr>
<tr>
<td>æ—¥èªŒè¨˜éŒ„</td>
<td><code>debug</code> æ§åˆ¶é™¤éŒ¯ logï¼Œ<code>pino</code> è™•ç†æ­£å¼æ—¥èªŒ</td>
</tr>
<tr>
<td>ä¾‹å¤–è™•ç†</td>
<td>sync ç”¨ try-catchï¼Œasync ç”¨ <code>next(err)</code></td>
</tr>
<tr>
<td>req.locals</td>
<td>ç”¨ä¾†è·¨ middleware å­˜å– userã€traceId ç­‰è³‡è¨Š</td>
</tr>
</tbody>
</table>
<hr />
    </article>
    <p class="post-meta">
      åŸæ–‡ï¼š
      <a href="https://github.com/Vincent23412/diary/blob/main/content/nodejs/best_practice_in_program.md" target="_blank">GitHub</a> Â·
      <a href="https://raw.githubusercontent.com/Vincent23412/diary/main/content/nodejs/best_practice_in_program.md" target="_blank">raw</a>
    </p>
  </main>

  <footer class="container py-24">
    <small>æœ€å¾Œæ›´æ–°ï¼š2026-02-28</small>
  </footer>
</body>
</html>

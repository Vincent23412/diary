<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Best Practice In Environment</title>
  <link rel="stylesheet" href="/notes/style.css" />
</head>
<body>
  <header class="container py-24">
    <h1 class="title">Best Practice In Environment</h1>
    <nav class="nav">
      <a href="/notes/nodejs/index.html" class="nav-link">â† å›åˆ†é¡</a>
      <a href="/notes/index.html" class="nav-link">å›ç¸½è¦½</a>
    </nav>
  </header>

  <main class="container card">
    <article class="post-content">
      <h1 id="nodejs-express">Node.js / Express ç”Ÿç”¢ç’°å¢ƒæ•ˆèƒ½å„ªåŒ–å®Œæ•´æ•´ç†</h1>
<h2 id="1-node_env-production">âœ… 1. è¨­å®š NODE_ENV ç‚º production</h2>
<ul>
<li>
<p><code>NODE_ENV=production</code> æœƒï¼š</p>
</li>
<li>
<p>å¿«å–è¦–åœ–æ¨¡æ¿</p>
</li>
<li>å¿«å– CSS é é¢è³‡æº</li>
<li>æ¸›å°‘éŒ¯èª¤è¨Šæ¯ç´°ç¯€ï¼ˆæ›´è¼•é‡ï¼‰</li>
<li>æ•ˆèƒ½æå‡æœ€é«˜å¯é” 3 å€ âœ…</li>
<li><strong>è¨­å®šæ–¹å¼</strong>ï¼š</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="na">Environment</span><span class="o">=</span><span class="s">NODE_ENV=production</span>
</code></pre></div>

<ul>
<li><strong>systemd ç¯„ä¾‹</strong>ï¼š<code>/etc/systemd/system/my-app.service</code></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">[Service]</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">NODE_ENV=production</span>
</code></pre></div>

<h2 id="2">âœ… 2. ç¢ºä¿æ‡‰ç”¨ç¨‹å¼å´©æ½°è‡ªå‹•é‡å•Ÿ</h2>
<table>
<thead>
<tr>
<th>æƒ…å¢ƒ</th>
<th>è§£æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node app å´©æ½°</td>
<td><strong>pm2 æˆ– cluster æ¨¡çµ„é‡å•Ÿ</strong> âœ…</td>
</tr>
<tr>
<td>ç³»çµ±å´©æ½°é‡å•Ÿ</td>
<td><strong>systemd</strong> è‡ªå‹•é‡å•Ÿ âœ…</td>
</tr>
</tbody>
</table>
<h3 id="systemd">ğŸ systemd ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">[Service]</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>
</code></pre></div>

<h2 id="3-init">âœ… 3. ä½¿ç”¨æµç¨‹ç®¡ç†å™¨èˆ‡ init ç³»çµ±</h2>
<ul>
<li><strong>æµç¨‹ç®¡ç†å™¨</strong>ï¼špm2ï¼Œå¯ clusterã€å¤š processã€log ç®¡ç†</li>
<li><strong>init ç³»çµ±</strong>ï¼šsystemdï¼Œè®“ server é‡é–‹æ©Ÿå¾Œ pm2 è‡ªå‹•å•Ÿå‹•</li>
</ul>
<h3 id="pm2-systemd">pm2 + systemd ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code>pm2<span class="w"> </span>start<span class="w"> </span>app.js<span class="w"> </span>--name<span class="w"> </span>my-app
pm2<span class="w"> </span>save
pm2<span class="w"> </span>startup<span class="w"> </span>systemd
</code></pre></div>

<h2 id="4-cluster">âœ… 4. ä½¿ç”¨ Cluster æ¨¡å¼</h2>
<table>
<thead>
<tr>
<th>å·¥å…·</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>cluster æ¨¡çµ„</td>
<td>Node.js å…§å»ºå¤šæ ¸å¿ƒè§£æ³• âœ…</td>
</tr>
<tr>
<td>pm2 cluster</td>
<td>ä¸€éµ clusterï¼Œ0 ç¨‹å¼ç¢¼è®Šå‹• âœ…</td>
</tr>
</tbody>
</table>
<h3 id="cluster-api">cluster API ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">isPrimary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">fork</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<h3 id="pm2">pm2 ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code>pm2<span class="w"> </span>start<span class="w"> </span>app.js<span class="w"> </span>-i<span class="w"> </span>max
</code></pre></div>

<h2 id="5">âœ… 5. å¿«å–è«‹æ±‚çµæœ</h2>
<table>
<thead>
<tr>
<th>å±¤ç´š</th>
<th>å·¥å…·</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‡‰ç”¨å±¤</td>
<td>Redis âœ…</td>
</tr>
<tr>
<td>ç¶²è·¯å±¤</td>
<td>Nginx Proxy Cache âœ…</td>
</tr>
</tbody>
</table>
<h3 id="nginx-proxy-cache">Nginx Proxy Cache ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">proxy_cache_path</span><span class="w"> </span><span class="s">/cache</span><span class="w"> </span><span class="s">keys_zone=my_cache:10m</span><span class="p">;</span>
<span class="k">location</span><span class="w"> </span><span class="s">/api/</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">my_cache</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://app</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6-load-balancer">âœ… 6. ä½¿ç”¨è² è¼‰å¹³è¡¡å™¨ (Load Balancer)</h2>
<table>
<thead>
<tr>
<th>å±¤ç´š</th>
<th>å·¥å…·</th>
</tr>
</thead>
<tbody>
<tr>
<td>å–®å°å¤š process</td>
<td>Nginx upstream</td>
</tr>
<tr>
<td>å¤šå° server</td>
<td>AWS ELB, HAProxy</td>
</tr>
</tbody>
</table>
<h3 id="nginx-upstream">Nginx upstream ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">upstream</span><span class="w"> </span><span class="s">backend</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kn">server</span><span class="w"> </span><span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">3001</span><span class="p">;</span>
<span class="w">  </span><span class="kn">server</span><span class="w"> </span><span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">3002</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://backend</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<h2 id="7-reverse-proxy">âœ… 7. ä½¿ç”¨åå‘ä»£ç† (Reverse Proxy)</h2>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>åå‘ä»£ç†è²¢ç»</th>
</tr>
</thead>
<tbody>
<tr>
<td>å£“ç¸®</td>
<td>gzip âœ…</td>
</tr>
<tr>
<td>å¿«å–</td>
<td>proxy_cache âœ…</td>
</tr>
<tr>
<td>SSL Offload</td>
<td>HTTPS ç”± Nginx è™•ç† âœ…</td>
</tr>
<tr>
<td>éœæ…‹æª”æ¡ˆæœå‹™</td>
<td>ç›´æ¥å¾ Nginx å›æ‡‰ JS/CSS âœ…</td>
</tr>
</tbody>
</table>
<h3 id="nginx-reverse-proxy">Nginx Reverse Proxy ç¯„ä¾‹ï¼š</h3>
<div class="codehilite"><pre><span></span><code><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">gzip</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/api/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://localhost:3000</span><span class="p">;</span><span class="w"> </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">my_cache</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/static/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">root</span><span class="w"> </span><span class="s">/var/www/static</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="8-redis-vs-nginx-cache">âœ… 8. Redis vs Nginx Cache å·®ç•°</h2>
<table>
<thead>
<tr>
<th>ç‰¹é»</th>
<th>Redis</th>
<th>Nginx Cache</th>
</tr>
</thead>
<tbody>
<tr>
<td>é‹ä½œå±¤ç´š</td>
<td>æ‡‰ç”¨å±¤</td>
<td>ç¶²è·¯å±¤ âœ…</td>
</tr>
<tr>
<td>ç²’åº¦</td>
<td>å–®ç­†è³‡æ–™å¿«å–</td>
<td>æ•´é å¿«å– âœ…</td>
</tr>
<tr>
<td>å€‹äººåŒ–æ”¯æ´</td>
<td>âœ… é©åˆå€‹äººåŒ–è³‡æ–™</td>
<td>âŒ ä¸é©åˆå€‹äººåŒ–é é¢</td>
</tr>
<tr>
<td>å¸¸è¦‹ç”¨é€”</td>
<td>æ’è¡Œæ¦œã€API æŸ¥è©¢å¿«å–</td>
<td>ç†±é–€é¦–é ã€éœæ…‹é é¢å¿«å– âœ…</td>
</tr>
</tbody>
</table>
<h2 id="9-elasticache-vs-ec2-redis">âœ… 9. ElastiCache vs EC2 è‡ªæ¶ Redis</h2>
<table>
<thead>
<tr>
<th>æ¯”è¼ƒ</th>
<th>ElastiCache</th>
<th>EC2 Redis</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¶­é‹</td>
<td>AWS è¨—ç®¡ âœ…</td>
<td>è‡ªå·±è£ã€ç¶­é‹ âŒ</td>
</tr>
<tr>
<td>HA</td>
<td>Multi-AZã€è‡ªå‹• failover âœ…</td>
<td>è‡ªå·±è¨­è¨ˆ</td>
</tr>
<tr>
<td>æ“´å±•æ€§</td>
<td>Redis Cluster âœ…</td>
<td>è‡ªå·±æ­ cluster</td>
</tr>
<tr>
<td>ç”¨æ³•</td>
<td>è·Ÿæœ¬æ©Ÿ Redis å®Œå…¨ä¸€æ¨£ âœ…</td>
<td>æœ¬æ©Ÿ Redis ç”¨æ³•</td>
</tr>
</tbody>
</table>
<hr />
<p>ğŸ“Œ <strong>å®Œæ•´æœ€ä½³å¯¦è¸ï¼š</strong></p>
<blockquote>
<p>Node.js æ‡‰ç”¨ï¼špm2 cluster â¡ï¸ systemd è¨—ç®¡ â¡ï¸ Nginx Proxy (å£“ç¸® + å¿«å– + åˆ†æµ) â¡ï¸ Redis è¼”åŠ©æ‡‰ç”¨å±¤å¿«å– â¡ï¸ AWS ELB æˆ– HAProxy åˆ†æµå¤šå°å¯¦ä¾‹ âœ…</p>
</blockquote>
    </article>
    <p class="post-meta">
      åŸæ–‡ï¼š
      <a href="https://github.com/Vincent23412/diary/blob/main/content/nodejs/best_practice_in_environment.md" target="_blank">GitHub</a> Â·
      <a href="https://raw.githubusercontent.com/Vincent23412/diary/main/content/nodejs/best_practice_in_environment.md" target="_blank">raw</a>
    </p>
  </main>

  <footer class="container py-24">
    <small>æœ€å¾Œæ›´æ–°ï¼š2026-01-22</small>
  </footer>
</body>
</html>
